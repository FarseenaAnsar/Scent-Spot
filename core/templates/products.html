{% extends "base.html" %}
{%  load static %}
{% block css%}
    <link href="{% static 'css/products.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block content %}
{% load cart %}
    <div class="row flex">
        <div class="row container">
            <div class="col-4 pos">
                <div class="img">
                    <div id="imageZoom">
                        <img class="card-img-top" src="{{product.image.url}}" alt="Card image cap" id="mainImage">
                        {% if out_of_stock or product.stock < 1 %}
                            <div class="out-of-stock-overlay">Out of Stock</div>
                        {% endif %}
                        <!-- Zoom overlay will be added by JavaScript -->
                    </div>
                </div>
                <!-- Additional images thumbnails -->
                <div class="additional-images mt-3">
                    <!-- Main image thumbnail -->
                    <div class="thumb-container active" onclick="setActiveThumb(this, '{{product.image.url}}')">
                        <img src="{{product.image.url}}" 
                            alt="Main image" 
                            class="thumb-img">
                    </div>
                    <!-- Additional images -->
                    {% for img in additional_images %}
                    <div class="thumb-container" onclick="setActiveThumb(this, '{{img.image.url}}')">
                        <img src="{{img.image.url}}" 
                            alt="Additional image" 
                            class="thumb-img">
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card col-8 content">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h1 class="card-text heading">{{product.name}}</h1>
                        {% if request.user.is_authenticated %}
                            <div class="wishlist-icon">
                                {% if product|is_in_wishlist:request.user %}
                                    <form action="{% url 'remove_from_wishlist' product.id %}" method="POST" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link p-0">
                                            <i class="fas fa-heart" style="color: red; font-size: 36px;"></i>
                                        </button>
                                    </form>
                                {% else %}
                                    <form action="{% url 'add_to_wishlist' product.id %}" method="POST" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link p-0">
                                            <i class="far fa-heart" style="font-size: 36px; color: black;"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    <p class="card-text size">({{product.size}})</p>
                    
                    <!-- Product Price with Offer Display -->
                    {% if product.has_offer %}
                        <div class="product-price mb-3">
                            <h4>
                                <span class="text-danger">‚Çπ{{ product.get_discount_price }}</span>
                                <small class="text-muted"><del>‚Çπ{{ product.price }}</del></small>
                                <span class="badge bg-success">{{ product.offer_details.discount_percentage }}% OFF</span>
                            </h4>
                            <p class="text-success">{{ product.offer_details.type }} offer: {{ product.offer_details.name }}</p>
                        </div>
                    {% else %}
                        <p class="card-text price">MRP: {{product.price|currency}}</p>
                    {% endif %}
                    
                    <small class="tax">Inclusive of all taxes</small>
                    <br>
                    <div class="product-rating mb-3">
                        {% if product.rating is not None and product.rating != 0 %}
                            {% for i in product.rating|loop_counter %}
                                <i class="fas fa-star" style="color:rgb(255, 234, 0);"></i>
                            {% endfor %}
                        {% else %}
                            {% for i in 5|loop_counter %}
                                <i class="fas fa-star"></i>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <p class="card-text brand">{{product.brand}}</p>
                    {% if product.gender == "women" %}
                        <p class="card-text gen w_g flex">{{product.gender}}</p>
                    {% else %}
                        <p class="card-text gen m_g flex">{{product.gender}}</p>
                    {% endif %}
                    {% if cat_type == "Celebrity Scents" %}
                        <p class="card-text flex celeb">EXCLUSIVE!!!</p>
                        <p class="card-text flex type">{{product.category.name}}</p>
                    {% else %}
                        <p class="card-text flex type">{{product.category.name}}</p>
                    {% endif %}

                    <div class="find-perfume-section">
                        <div class="find-perfume-content">
                            <p>Let our AI help you find your perfect scent match!</p>
                            <a href="{% url 'perfume_finder' %}" class="find-perfume-link">
                                <span class="icon">üîç</span>
                                Find Your Perfect Perfume
                            </a>
                        </div>
                    </div>
                    
                    <br>
                    {% if out_of_stock or product.stock < 1 %}
                        <button class="btn btn-sm cartbtn" disabled>Add to Cart</button>
                    {% else %}
                        <form action="/products" method="POST" class="d-flex flex-row p-1">
                            {% csrf_token %}
                            <div class="input-group mb-3" style="max-width: 200px;">
                                <input type="number" name="amount" id="quantity" class="form-control text-center" value="1" min="1" max="3">
                            </div>
                            <input hidden type="text" class="btn btn-primary btn-sm" value="{{product.id}}" name="prdid">
                            <input type="submit" class="btn btn-sm cartbtn" value="ADD TO CART">
                        </form>
                        {% if request.session.cart %}
                            {% with product|is_in_cart:request.session.cart as in_cart %}
                                {% if in_cart %}
                                <div class="card-footer p-0 row">
                                    <div class="text-center">{{in_cart}} already in Cart</div>
                                </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row flex">
        <div class="row container">
            <div class="card col con_des">
                <div class="card-body">
                    <h1 class="card-text price">Product Description</h1>
                    <br>
                    <p class="card-text description">{{product.description}}</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Similar Products Section -->
    <section class="similar-products">
        <h3 class="section-title">Similar Products</h3>
        <div class="similar-products-grid">
            {% for similar_product in similar_products %}
                <div class="similar-product-card">
                    <a class="product_btn" href="/products?product_id={{similar_product.id}}">
                        <img src="{{ similar_product.image.url }}" alt="{{ similar_product.name }}">    
                        <div class="similar-product-info">
                            <h4>{{ similar_product.name }}</h4>
                            {% if similar_product.has_offer %}
                                <p class="price">
                                    <span class="text-danger">‚Çπ{{ similar_product.get_discount_price }}</span>
                                    <small class="text-muted"><del>‚Çπ{{ similar_product.price }}</del></small>
                                </p>
                            {% else %}
                                <p class="price">‚Çπ{{ similar_product.price }}</p>
                            {% endif %}
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </section>
{% endblock %}
{% block js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageZoom = document.getElementById('imageZoom');
            const mainImage = document.getElementById('mainImage');
            
            if (imageZoom && mainImage) {
                imageZoom.addEventListener('mousemove', (e) => {
                    const rect = imageZoom.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    
                    mainImage.style.transformOrigin = `${x}% ${y}%`;
                });
            }
        });
        
        function changeMainImage(src) {
            const mainImage = document.getElementById('mainImage');
            if (mainImage) {
                mainImage.src = src;
            }
        }
        
        function setActiveThumb(clickedThumb, src) {
            console.log('Clicked thumbnail with src:', src);
            
            // Remove active class from all thumbnails
            document.querySelectorAll('.thumb-container').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            // Add active class to clicked thumbnail
            clickedThumb.classList.add('active');
            
            // Change main image
            const mainImage = document.getElementById('mainImage');
            if (mainImage) {
                console.log('Changing main image to:', src);
                mainImage.src = src;
            } else {
                console.log('Main image element not found');
            }
        }
        
        function updateActiveThumbnail(clickedThumb) {
            // Remove active border from all thumbnails
            document.querySelectorAll('.thumb-container').forEach(container => {
                container.style.borderColor = 'transparent';
            });
            // Add active border to clicked thumbnail
            clickedThumb.parentElement.style.borderColor = '#333';
        }
        
        function initializeImageSwitching() {
            const thumbnails = document.querySelectorAll('.thumb-img');
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function(e) {
                    // Change main image with fade effect
                    changeMainImage(this.src);
                    
                    // Update active thumbnail
                    updateActiveThumbnail(this);
                });
            });
        }
        
        function incrementQuantity() {
            const quantityInput = document.getElementById('quantity');
            const maxQuantity = parseInt(quantityInput.getAttribute('max') || '{{ product.stock }}');
            let currentQuantity = parseInt(quantityInput.value);
            
            if (currentQuantity < maxQuantity) {
                quantityInput.value = currentQuantity + 1;
            }
        }
        
        function decrementQuantity() {
            const quantityInput = document.getElementById('quantity');
            let currentQuantity = parseInt(quantityInput.value);
            
            if (currentQuantity > 1) {
                quantityInput.value = currentQuantity - 1;
            }
        }
        
        function addToWishlist(productId) {
            fetch('/wishlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `action=add&product_id=${productId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert(data.message || 'Error adding to wishlist');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding to wishlist');
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize main image switching functionality
            initializeImageSwitching();
        });
    </script>
{% endblock %}