<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-CuOF+2SnTUfTwSZjCXf01h7uYhfOBuxIhGKPbfEJ3+FqH/s6cIFN9bGr1HmAg4fQ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Payment</title>
</head>
<body>
  {% load static %}
  {% load cart %}
  {% load custom_filters %}
    <div class="info">
        <div class="container">
          <br>
          <h1 style="text-align:center;">Payment Summary</h1>
          <br><br>
          <table class="table table-striped table-hover">
            <tr>
                <th>Original Cart Value</th>
                <td>{{original_total|currency}}</td>
            </tr>
            {% if offer_discount %}
            <tr>
                <th>Product Offers</th>
                <td class="text-success">-{{offer_discount|currency}}</td>
            </tr>
            <tr>
                <th>Cart Value After Offers</th>
                <td>{{total|currency}}</td>
            </tr>
            {% endif %}
            {% if discount %}
            <tr>
                <th>Coupon Discount</th>
                <td class="text-success">-{{discount|currency}}</td>
            </tr>
            {% endif %}
            <tr>
                <th>Convenience Fee</th>
                <td>{{99|currency}}</td>
            </tr>
            <br>
            <tr>
                <th>Total payable</th> 
                <td>{% if discount %}{{total|subtract:discount|sum:99|currency}}{% else %}{{total|sum:99|currency}}{% endif %}</td>
            </tr>
          </table>
          <form id="payment-form" method="POST">
            {% csrf_token %}
            <div class="form-group">
              <label for="name">Full Name*</label>
              <input type="text" name="fname" id="name" class="form-control" required>
              <div class="invalid-feedback" id="name-error">
                  Please enter your full name
              </div>
            </div>
            <div class="form-group">
              <label for="email">Email Address*</label>
              <input type="email" name="email" id="email" class="form-control" required>
              <div class="invalid-feedback" id="email-error">
                  Please enter a valid email address
              </div>
            </div>
            <div class="form-group">
              <label for="phone">Contact Number*</label>
              <input type="tel" name="phone" id="phone" class="form-control" required>
              <div class="invalid-feedback" id="phone-error">
                  Please enter a valid contact number
              </div>
            </div>
            <div class="form-group">
                <label for="address">Shipping Address*</label>
                <textarea name="address" id="address" class="form-control" required></textarea>
                <div class="invalid-feedback" id="address-error">
                  Please enter a valid shipping address
                </div>
            </div>
            <!-- Adding payment method selection here -->
            <div class="payment-options">
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="razorpay" value="razorpay" checked>
                  <label class="form-check-label" for="razorpay">
                      Pay Online (Credit/Debit Card, UPI, etc.)
                  </label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod">
                  <label class="form-check-label" for="cod">
                      Cash on Delivery
                  </label>
              </div>
            </div>
            {% if discount %}
              <input type="hidden" name="total" value="{{ total|subtract:discount|sum:99 }}">
            {% else %}
              <input type="hidden" name="total" value="{{ total|sum:99 }}">
            {% endif %}
            <button type="button" id="place-order-btn" class="btn btn-primary">Place Order</button>
          </form>
        
        </div>
      </div>

  <script>
    $(document).ready(function() {
      $("#place-order-btn").click(function(e) {
        e.preventDefault(); // Prevent default form submission
        const paymentMethod = $('input[name="payment_method"]:checked').val();
        const form = $('#payment-form');
        
        if (paymentMethod === 'cod') {
          // Submit to COD endpoint
          $.ajax({
            type: "POST",
            url: "{% url 'place_cod_order' %}",
            data: form.serialize(),
            success: function(response) {
              if (response.status === 'success') {
                window.location.href = response.redirect_url;
              } else {
                alert(response.message || "Error processing your order");
              }
            },
            error: function() {
              alert("Error processing your order. Please try again.");
            }
          });
        } else {
          // For Razorpay payment
          $.ajax({
            type: "POST",
            url: "{% url 'razorpaycheck' %}",
            data: form.serialize(), // This includes the total with discount and convenience fee
            dataType: 'json',
            success: function(response) {
              var options = {
                key: response.key,
                amount: response.amount,
                currency: "INR",
                name: "ScentSpot",
                description: "Purchase from ScentSpot",
                order_id: response.order_id,
                handler: function(paymentResponse) {
                  // On successful payment
                  $.ajax({
                    type: "POST",
                    url: "{% url 'verify_payment' %}",
                    data: {
                      'payment_id': paymentResponse.razorpay_payment_id,
                      'order_id': paymentResponse.razorpay_order_id,
                      'signature': paymentResponse.razorpay_signature,
                      'address': $("#address").val(),
                      'phone': $("#phone").val(),
                      'fname': $("#name").val(),
                      'email': $("#email").val(),
                      'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val()
                    },
                    success: function(serverResponse) {
                      if (serverResponse.status === 'success') {
                        window.location.href = "/payment-success/" + paymentResponse.razorpay_payment_id + "/";
                      } else {
                        alert(serverResponse.message || "Payment verification failed");
                      }
                    }
                  });
                },
                prefill: {
                  name: $("#name").val(),
                  email: $("#email").val(),
                  contact: $("#phone").val()
                },
                theme: {
                  color: "#3399cc"
                }
              };
              
              // Initialize Razorpay
              var rzp1 = new Razorpay(options);
              rzp1.open();
            },
            error: function(xhr, status, error) {
              console.error("Error:", error);
              alert("Error processing your payment request. Please try again.");
            }
          });
        }
      });
    });
  </script>

  </script>
</body>
</html>
